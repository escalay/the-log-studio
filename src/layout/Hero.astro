---
import { createDb } from '@/db'
import { entries } from '../../drizzle/schema'
import { sql } from 'drizzle-orm'

const db = createDb(Astro.locals.runtime.env.DB)

const counts = await db
  .select({
    level: entries.level,
    count: sql<number>`count(*)`.as('count'),
  })
  .from(entries)
  .groupBy(entries.level)

const totalEntries = counts.reduce((sum, r) => sum + r.count, 0)
const countByLevel = Object.fromEntries(counts.map((r) => [r.level, r.count]))

const version = __APP_VERSION__

const hasEntries = totalEntries > 0

const marqueeItems = hasEntries
  ? [
      `V${version}`,
      `${totalEntries} ENTRIES`,
      countByLevel[0] ? `${countByLevel[0]} LAB NOTES` : null,
      countByLevel[1] ? `${countByLevel[1]} EXPERIMENTS` : null,
      countByLevel[2] ? `${countByLevel[2]} PROJECTS` : null,
      countByLevel[3] ? `${countByLevel[3]} PRODUCTS` : null,
      'OPEN SOURCE',
    ].filter(Boolean) as string[]
  : [
      `V${version}`,
      'OPEN SOURCE',
      'INITIALIZING',
      'AWAITING FIRST ENTRY',
      'L0 → L1 → L2 → L3',
      'IDEAS BECOME PRODUCTS',
    ]

const separator = '///'
---

<header class="relative min-h-[50vh] bg-[#FDFCF8] border-b border-ink flex flex-col justify-between overflow-hidden">
  <div class="absolute inset-0 bg-dot-grid opacity-30 pointer-events-none"></div>
  <div class="absolute top-0 w-full h-1 bg-hazard-stripes opacity-100 z-50"></div>

  <div class="container mx-auto max-w-7xl flex-1 flex flex-col justify-center px-6 md:px-12 py-12 md:py-0 relative z-10">
    <div class="grid md:grid-cols-12 gap-12 items-end">
      <div class="md:col-span-7 lg:col-span-8">
        <div class="inline-flex items-center gap-2 px-2 py-1 bg-ink text-white font-mono text-[10px] font-bold uppercase tracking-widest mb-6">
          <span class="w-1.5 h-1.5 bg-accent rounded-full animate-pulse"></span>
          V{version}
        </div>

        <h1 class="text-7xl md:text-8xl lg:text-[9rem] font-serif font-bold text-ink tracking-tighter leading-[0.85] mb-6">
          ESCALAY<span class="text-accent">.</span>
        </h1>

        <p class="font-sans text-lg md:text-xl text-subtle max-w-xl leading-relaxed border-l-2 border-ink/10 pl-6">
          The operating system for ideas. Tracking the evolution from <span class="border-b border-ink/20">raw notes</span> to <span class="border-b border-ink/20">shipping products</span>.
        </p>
      </div>

      <div class="md:col-span-5 lg:col-span-4 flex flex-col items-start md:items-end gap-8">
        <div class="bg-white p-6 border-l-4 border-ink shadow-sm w-full transition-transform hover:-translate-y-1 duration-300">
          <div class="font-mono text-[10px] text-subtle uppercase mb-2 tracking-wider border-b border-ink/10 pb-2">
            Primary Directive
          </div>
          <div class="font-serif italic text-2xl text-ink leading-tight">
            "Revenue is water.<br/>
            Code is overhead.<br/>
            <span class="text-accent font-bold not-italic bg-accent/5 px-1">Ship or die.</span>"
          </div>
        </div>

        <a
          href="#main"
          onclick="window.posthog?.capture('hero_cta_clicked')"
          class="group flex items-center gap-4 px-6 py-3 bg-white border border-ink font-mono text-xs font-bold uppercase tracking-widest hover:bg-ink hover:text-white transition-all shadow-hard-sm hover:shadow-hard hover:-translate-y-0.5"
        >
          Initialize System
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-3 h-3 group-hover:translate-x-1 transition-transform"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
        </a>
      </div>
    </div>
  </div>

  <div class="border-t border-ink bg-white py-3 overflow-hidden whitespace-nowrap z-20 shrink-0">
    <div class="animate-marquee flex gap-12 items-center font-mono text-[10px] font-bold uppercase tracking-[0.2em] text-ink/80">
      {[1,2,3].map(() => (
        marqueeItems.map((item) => (
          <>
            <span>{item}</span>
            <span class="text-subtle opacity-30">{separator}</span>
          </>
        ))
      ))}
    </div>
  </div>
</header>
