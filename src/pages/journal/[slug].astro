---
import BaseLayout from '@/layouts/BaseLayout.astro'
import Navbar from '@/layout/Navbar.astro'
import { Footer } from '@/layout/Footer'
import { JournalPage } from '@/journal/JournalPage'
import { createDb } from '@/db'
import { journalEntries, journalBlocks } from '../../../drizzle/schema'
import { eq, asc } from 'drizzle-orm'

const { slug } = Astro.params
const db = createDb(Astro.locals.runtime.env.DB)

const rows = await db.select().from(journalEntries).where(eq(journalEntries.slug, slug!))
if (rows.length === 0) {
  return Astro.redirect('/journal')
}

const blocks = await db
  .select()
  .from(journalBlocks)
  .where(eq(journalBlocks.journalEntryId, rows[0].id))
  .orderBy(asc(journalBlocks.sortOrder))

const post = {
  ...rows[0],
  blocks: blocks.map((b) => ({
    type: b.type as 'markdown' | 'component' | 'image' | 'pull-quote',
    content: b.content,
    componentName: b.componentName ?? undefined,
  })),
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site ?? Astro.url.origin)

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: post.title,
  description: post.subtitle,
  datePublished: post.createdAt,
  dateModified: post.updatedAt,
  url: canonicalURL.href,
  image: new URL(`/og/journal/${post.slug}.png`, Astro.site ?? Astro.url.origin).href,
  author: {
    '@type': 'Organization',
    name: 'Escalay',
    url: 'https://log.escalay.app',
  },
  publisher: {
    '@type': 'Organization',
    name: 'Escalay',
  },
}
---

<BaseLayout title={`${post.title} â€” The Register`} description={post.subtitle} ogImage={`/og/journal/${post.slug}.png`} jsonLd={jsonLd}>
  <div class="min-h-screen flex flex-col font-sans text-ink bg-dot-grid relative overflow-x-hidden w-full">
    <Navbar active="journal" />
    <main class="flex-1 relative z-10 container mx-auto max-w-7xl md:border-x md:border-ink bg-paper">
      <JournalPage post={post} client:load />
    </main>
    <Footer client:idle />
  </div>
</BaseLayout>
